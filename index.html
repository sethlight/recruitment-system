<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SALOWIN ATS</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .lucide { 
            width: 1em; 
            height: 1em; 
            fill: none; 
            stroke: currentColor; 
            stroke-width: 2; 
            stroke-linecap: round; 
            stroke-linejoin: round; 
        }
        .dragging {
            opacity: 0.5;
        }
        .drag-over {
            background-color: #e0e7ff;
        }
        .highlight-candidate {
            animation: highlight 2s ease-in-out;
        }
        @keyframes highlight {
            0% { background-color: #fbbf24; }
            100% { background-color: transparent; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useCallback, useEffect, useMemo, useRef } = React;

        // アイコンコンポーネント（既存のものに追加）
        const Eye = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
            </svg>
        );

        const FilterX = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M13.013 3H2l8 9.46V19l4 2v-8.54l.9-1.055"/>
                <line x1="22" x2="18" y1="3" y2="7"/>
                <line x1="18" x2="22" y1="3" y2="7"/>
            </svg>
        );

        const Home = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
        );

        // 既存のアイコンコンポーネント（Plus, User, Clock, など）はそのまま保持
        const Plus = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M5 12h14M12 5v14"/>
            </svg>
        );

        const User = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
            </svg>
        );

        const Clock = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12,6 12,12 16,14"/>
            </svg>
        );

        const MoreHorizontal = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="1"/>
                <circle cx="19" cy="12" r="1"/>
                <circle cx="5" cy="12" r="1"/>
            </svg>
        );

        const Edit3 = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M12 20h9"/>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/>
            </svg>
        );

        const Trash2 = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <polyline points="3,6 5,6 21,6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                <line x1="10" y1="11" x2="10" y2="17"/>
                <line x1="14" y1="11" x2="14" y2="17"/>
            </svg>
        );

        const ArrowLeft = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
        );

        const RotateCcw = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
            </svg>
        );

        const Wifi = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="m1 9 4-4 4 4"/>
                <path d="m1 9 4-4 4 4"/>
                <circle cx="12" cy="19" r="1"/>
                <path d="M5 12.859a10 10 0 0 1 14 0"/>
                <path d="M8.5 16.429a5 5 0 0 1 7 0"/>
            </svg>
        );

        const WifiOff = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="m12 20 3-3 3 3-3 3-3-3z"/>
                <path d="M8.5 16.429a5 5 0 0 1 7 0"/>
                <path d="M5 12.859a10 10 0 0 1 5.17-2.69"/>
                <path d="m2 2 20 20"/>
                <path d="M16.83 10.17a10 10 0 0 1 2.17 2.69"/>
            </svg>
        );

        const Settings = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"/>
                <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m20.485-5.485l-4.242 4.242m-8.486 0l-4.242-4.242m0 8.486l4.242-4.242m8.486 0l4.242 4.242"/>
            </svg>
        );

        const History = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M3 3v5h5"/>
                <path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/>
                <path d="M12 7v5l4 2"/>
            </svg>
        );

        const ChevronUp = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="m18 15-6-6-6 6"/>
            </svg>
        );

        const ChevronDown = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="m6 9 6 6 6-6"/>
            </svg>
        );

        const GripVertical = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="9" cy="12" r="1"/>
                <circle cx="9" cy="5" r="1"/>
                <circle cx="9" cy="19" r="1"/>
                <circle cx="15" cy="12" r="1"/>
                <circle cx="15" cy="5" r="1"/>
                <circle cx="15" cy="19" r="1"/>
            </svg>
        );

        const X = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        );

        const Calendar = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                <line x1="16" x2="16" y1="2" y2="6"/>
                <line x1="8" x2="8" y1="2" y2="6"/>
                <line x1="3" x2="21" y1="10" y2="10"/>
            </svg>
        );

        const LogOut = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                <polyline points="16 17 21 12 16 7"/>
                <line x1="21" x2="9" y1="12" y2="12"/>
            </svg>
        );

        const Search = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="11" cy="11" r="8"/>
                <path d="m21 21-4.35-4.35"/>
            </svg>
        );

        const Filter = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
            </svg>
        );

        const Download = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" x2="12" y1="15" y2="3"/>
            </svg>
        );

        // 数値フォーマット関数
        const formatNumber = (value) => {
            // 数値以外の文字を削除
            const numericValue = value.replace(/[^\d]/g, '');
            if (!numericValue) return '';
            
            // 3桁ごとにカンマを挿入
            return Number(numericValue).toLocaleString('ja-JP');
        };

        // フォーマットされた数値を元に戻す
        const unformatNumber = (value) => {
            return value.replace(/,/g, '');
        };

        // 採用者属性の定数
        const HIRING_ATTRIBUTES = [
          { value: 'experienced', label: '経験者' },
          { value: 'potential', label: 'ポテンシャル採用' },
          { value: 'skill-dependent', label: 'スキル次第' },
          { value: 'none', label: '特になし' }
        ];

        // 採用フェーズの初期値
        const DEFAULT_RECRUITMENT_PHASES = [
          { id: 'application', name: '応募', color: 'bg-pink-500' },
          { id: 'screening', name: '書類選考', color: 'bg-blue-500' },
          { id: 'interview1', name: '一次面接', color: 'bg-orange-500' },
          { id: 'interview2', name: '二次面接', color: 'bg-purple-500' },
          { id: 'final', name: '最終面接', color: 'bg-indigo-500' },
          { id: 'offer', name: '内定', color: 'bg-green-500' },
          { id: 'hired', name: '採用決定', color: 'bg-emerald-500' },
          { id: 'declined', name: '辞退', color: 'bg-orange-500' },
          { id: 'rejected', name: '不合格', color: 'bg-red-500' }
        ];

        // 利用可能な色（日本語表記付き）
        const AVAILABLE_COLORS = [
          { value: 'bg-pink-500', label: 'ピンク', preview: '#ec4899' },
          { value: 'bg-blue-500', label: '青', preview: '#3b82f6' },
          { value: 'bg-orange-500', label: 'オレンジ', preview: '#f97316' },
          { value: 'bg-purple-500', label: '紫', preview: '#a855f7' },
          { value: 'bg-indigo-500', label: '藍色', preview: '#6366f1' },
          { value: 'bg-green-500', label: '緑', preview: '#22c55e' },
          { value: 'bg-emerald-500', label: 'エメラルド', preview: '#10b981' },
          { value: 'bg-red-500', label: '赤', preview: '#ef4444' },
          { value: 'bg-yellow-500', label: '黄色', preview: '#eab308' },
          { value: 'bg-cyan-500', label: 'シアン', preview: '#06b6d4' },
          { value: 'bg-gray-500', label: 'グレー', preview: '#6b7280' },
          { value: 'bg-teal-500', label: 'ティール', preview: '#14b8a6' }
        ];

        // ナビゲーション履歴管理
        class NavigationHistory {
            constructor() {
                this.history = this.loadHistory();
            }

            loadHistory() {
                try {
                    const saved = localStorage.getItem('navigation-history');
                    return saved ? JSON.parse(saved) : [];
                } catch {
                    return [];
                }
            }

            saveHistory() {
                try {
                    localStorage.setItem('navigation-history', JSON.stringify(this.history));
                } catch (error) {
                    console.error('Failed to save navigation history:', error);
                }
            }

            push(route) {
                // 重複を避けるため、同じルートは削除してから追加
                this.history = this.history.filter(item => 
                    !(item.type === route.type && item.id === route.id)
                );
                this.history.push({
                    ...route,
                    timestamp: Date.now()
                });
                
                // 履歴を最大10件に制限
                if (this.history.length > 10) {
                    this.history = this.history.slice(-10);
                }
                
                this.saveHistory();
            }

            pop() {
                if (this.history.length > 0) {
                    const lastRoute = this.history.pop();
                    this.saveHistory();
                    return lastRoute;
                }
                return null;
            }

            getCurrentRoute() {
                return this.history.length > 0 ? this.history[this.history.length - 1] : null;
            }

            clear() {
                this.history = [];
                this.saveHistory();
            }

            hasHistory() {
                return this.history.length > 1;
            }
        }

        // データベース操作クラス
        class DatabaseManager {
            constructor() {
                this.isOnline = navigator.onLine;
                this.setupOnlineListener();
            }

            setupOnlineListener() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.syncLocalToRemote();
                });
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                });
            }

            async saveData(data) {
                try {
                    // 常にローカルストレージにバックアップ保存
                    localStorage.setItem('recruitmentPositions', JSON.stringify(data));
                    localStorage.setItem('lastLocalUpdate', new Date().toISOString());

                    // オンラインの場合は共有データベースにも保存
                    if (this.isOnline) {
                        const response = await fetch('/api/positions', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer sarowin-team'
                            },
                            body: JSON.stringify({
                                data: data,
                                timestamp: new Date().toISOString(),
                                userId: this.getUserId()
                            })
                        });

                        if (response.ok) {
                            localStorage.setItem('lastSuccessfulSync', new Date().toISOString());
                            return { success: true, source: 'remote' };
                        } else {
                            throw new Error('Remote save failed');
                        }
                    } else {
                        // オフラインの場合は待機中としてマーク
                        localStorage.setItem('pendingSync', 'true');
                        return { success: true, source: 'local' };
                    }
                } catch (error) {
                    console.error('Save failed:', error);
                    // リモート保存に失敗してもローカルには保存されている
                    localStorage.setItem('pendingSync', 'true');
                    return { success: true, source: 'local', error: error.message };
                }
            }

            async loadData() {
                try {
                    if (this.isOnline) {
                        // オンラインの場合は最新データを取得
                        const response = await fetch('/api/positions', {
                            headers: { 'Authorization': 'Bearer sarowin-team' }
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.data && Array.isArray(result.data)) {
                                // リモートデータをローカルにも保存
                                localStorage.setItem('recruitmentPositions', JSON.stringify(result.data));
                                localStorage.setItem('lastSuccessfulSync', new Date().toISOString());
                                return { data: result.data, source: 'remote', timestamp: result.timestamp };
                            }
                        }
                    }

                    // オフラインまたはリモート取得失敗時はローカルデータを使用
                    const localData = localStorage.getItem('recruitmentPositions');
                    if (localData) {
                        const data = JSON.parse(localData);
                        return { 
                            data: data, 
                            source: 'local',
                            timestamp: localStorage.getItem('lastLocalUpdate')
                        };
                    }

                    // 初回起動時のデフォルトデータ
                    return { data: this.getDefaultData(), source: 'default' };

                } catch (error) {
                    console.error('Load failed:', error);
                    // エラー時はローカルデータまたはデフォルトデータを返す
                    const localData = localStorage.getItem('recruitmentPositions');
                    if (localData) {
                        try {
                            return { data: JSON.parse(localData), source: 'local' };
                        } catch {
                            return { data: this.getDefaultData(), source: 'default' };
                        }
                    }
                    return { data: this.getDefaultData(), source: 'default' };
                }
            }

            async syncLocalToRemote() {
                const pendingSync = localStorage.getItem('pendingSync');
                if (pendingSync === 'true' && this.isOnline) {
                    const localData = localStorage.getItem('recruitmentPositions');
                    if (localData) {
                        try {
                            const data = JSON.parse(localData);
                            await this.saveData(data);
                            localStorage.removeItem('pendingSync');
                        } catch (error) {
                            console.error('Sync failed:', error);
                        }
                    }
                }
            }

            getUserId() {
                let userId = localStorage.getItem('userId');
                if (!userId) {
                    userId = 'user_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('userId', userId);
                }
                return userId;
            }

            getDefaultData() {
                return [
                    { 
                      id: 1, 
                      name: 'ネイル本部人員（セールス＆CS）',
                      department: 'リテール事業部',
                      hiringManager: '田中マネージャー',
                      hiringAttribute: 'experienced',
                      phases: DEFAULT_RECRUITMENT_PHASES.map(phase => ({ ...phase, candidates: [] }))
                    },
                    { 
                      id: 2, 
                      name: 'アイリスト本部人員（セールス＆CS）',
                      department: 'リテール事業部',
                      hiringManager: '山田部長',
                      hiringAttribute: 'potential',
                      phases: DEFAULT_RECRUITMENT_PHASES.map(phase => ({ ...phase, candidates: [] }))
                    }
                ];
            }

            getConnectionStatus() {
                const lastSync = localStorage.getItem('lastSuccessfulSync');
                const pendingSync = localStorage.getItem('pendingSync') === 'true';
                
                return {
                    isOnline: this.isOnline,
                    lastSync: lastSync ? new Date(lastSync) : null,
                    pendingSync: pendingSync
                };
            }
        }

        // 候補者抽出モーダル（改良版）
        const CandidateFilterModal = ({ isOpen, positions, onClose, onNavigateToCandidate, currentPositionId = null, onApplyFilter = null }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedPosition, setSelectedPosition] = useState(currentPositionId || 'all');
            const [selectedPhase, setSelectedPhase] = useState('all');
            const [selectedAttribute, setSelectedAttribute] = useState('all');
            const [customFieldFilters, setCustomFieldFilters] = useState([]);
            const [filterLogic, setFilterLogic] = useState('AND');
            const [results, setResults] = useState([]);
            const [showResults, setShowResults] = useState(false);

            // currentPositionIdが変更されたら反映
            useEffect(() => {
                if (currentPositionId) {
                    setSelectedPosition(currentPositionId);
                }
            }, [currentPositionId]);

            // 全候補者から動的にカスタムフィールドを収集
            const availableCustomFields = useMemo(() => {
                const fieldsMap = new Map();
                
                positions.forEach(position => {
                    position.phases.forEach(phase => {
                        phase.candidates.forEach(candidate => {
                            if (candidate.customFields) {
                                candidate.customFields.forEach(field => {
                                    if (!fieldsMap.has(field.name)) {
                                        fieldsMap.set(field.name, new Set());
                                    }
                                    if (field.value) {
                                        fieldsMap.get(field.name).add(field.value);
                                    }
                                });
                            }
                        });
                    });
                });

                return Array.from(fieldsMap.entries()).map(([name, values]) => ({
                    name,
                    values: Array.from(values).sort()
                }));
            }, [positions]);

            // フィルタ追加
            const addCustomFieldFilter = () => {
                setCustomFieldFilters([...customFieldFilters, {
                    id: Date.now(),
                    fieldName: '',
                    operator: 'equals',
                    value: '',
                    value2: ''
                }]);
            };

            // フィルタ更新
            const updateCustomFieldFilter = (id, updates) => {
                setCustomFieldFilters(customFieldFilters.map(filter =>
                    filter.id === id ? { ...filter, ...updates } : filter
                ));
            };

            // フィルタ削除
            const removeCustomFieldFilter = (id) => {
                setCustomFieldFilters(customFieldFilters.filter(filter => filter.id !== id));
            };

            // 演算子の選択肢を取得
            const getOperatorsForField = (fieldName) => {
                // フィールドの値から数値フィールドかどうかを判定
                const isNumericField = positions.some(position =>
                    position.phases.some(phase =>
                        phase.candidates.some(candidate => {
                            const field = candidate.customFields?.find(f => f.name === fieldName);
                            return field && field.isNumeric;
                        })
                    )
                );

                if (isNumericField) {
                    return [
                        { value: 'equals', label: '完全一致' },
                        { value: 'gte', label: '以上' },
                        { value: 'gt', label: 'より大きい' },
                        { value: 'lte', label: '以下' },
                        { value: 'lt', label: 'より小さい' },
                        { value: 'between', label: '範囲内' }
                    ];
                } else {
                    return [
                        { value: 'equals', label: '完全一致' },
                        { value: 'contains', label: '部分一致' },
                        { value: 'startsWith', label: '前方一致' },
                        { value: 'endsWith', label: '後方一致' }
                    ];
                }
            };

            // 検索実行
            const executeSearch = () => {
                const filteredCandidates = [];

                positions.forEach(position => {
                    // ポジションフィルタ
                    if (selectedPosition !== 'all' && position.id !== parseInt(selectedPosition)) {
                        return;
                    }

                    // 採用者属性フィルタ
                    if (selectedAttribute !== 'all' && position.hiringAttribute !== selectedAttribute) {
                        return;
                    }

                    position.phases.forEach(phase => {
                        // フェーズフィルタ
                        if (selectedPhase !== 'all' && phase.id !== selectedPhase) {
                            return;
                        }

                        phase.candidates.forEach(candidate => {
                            let matches = true;

                            // 名前検索
                            if (searchTerm) {
                                const searchLower = searchTerm.toLowerCase();
                                const nameMatches = candidate.name.toLowerCase().includes(searchLower);
                                const notesMatches = candidate.notes && candidate.notes.toLowerCase().includes(searchLower);
                                
                                if (!nameMatches && !notesMatches) {
                                    matches = false;
                                }
                            }

                            // カスタムフィールドフィルタ
                            if (customFieldFilters.length > 0 && matches) {
                                const filterResults = customFieldFilters.map(filter => {
                                    if (!filter.fieldName || !filter.value) return true;

                                    const field = candidate.customFields?.find(f => f.name === filter.fieldName);
                                    if (!field) return false;

                                    // 数値フィールドの場合
                                    if (field.isNumeric) {
                                        const fieldValue = parseFloat(field.value.replace(/,/g, ''));
                                        const filterValue = parseFloat(filter.value.replace(/,/g, ''));
                                        
                                        if (isNaN(fieldValue) || isNaN(filterValue)) return false;

                                        switch (filter.operator) {
                                            case 'equals':
                                                return fieldValue === filterValue;
                                            case 'gte':
                                                return fieldValue >= filterValue;
                                            case 'gt':
                                                return fieldValue > filterValue;
                                            case 'lte':
                                                return fieldValue <= filterValue;
                                            case 'lt':
                                                return fieldValue < filterValue;
                                            case 'between':
                                                if (filter.value2) {
                                                    const filterValue2 = parseFloat(filter.value2.replace(/,/g, ''));
                                                    return fieldValue >= filterValue && fieldValue <= filterValue2;
                                                }
                                                return true;
                                            default:
                                                return true;
                                        }
                                    } else {
                                        // テキストフィールドの場合
                                        const fieldValue = field.value.toLowerCase();
                                        const filterValue = filter.value.toLowerCase();

                                        switch (filter.operator) {
                                            case 'equals':
                                                return fieldValue === filterValue;
                                            case 'contains':
                                                return fieldValue.includes(filterValue);
                                            case 'startsWith':
                                                return fieldValue.startsWith(filterValue);
                                            case 'endsWith':
                                                return fieldValue.endsWith(filterValue);
                                            default:
                                                return true;
                                        }
                                    }
                                });

                                if (filterLogic === 'AND') {
                                    matches = filterResults.every(result => result);
                                } else {
                                    matches = filterResults.some(result => result);
                                }
                            }

                            if (matches) {
                                filteredCandidates.push({
                                    ...candidate,
                                    positionName: position.name,
                                    positionId: position.id,
                                    phaseName: phase.name,
                                    phaseId: phase.id,
                                    department: position.department,
                                    hiringManager: position.hiringManager,
                                    hiringAttribute: position.hiringAttribute
                                });
                            }
                        });
                    });
                });

                setResults(filteredCandidates);
                setShowResults(true);
            };

            // CSV出力
            const exportToCSV = () => {
                if (results.length === 0) return;

                // ヘッダー作成
                const headers = ['候補者名', 'ポジション', '部署', '採用責任者', '採用者属性', 'フェーズ', 'メモ', '登録日'];
                
                // 動的なカスタムフィールドのヘッダーを追加
                const allCustomFieldNames = new Set();
                results.forEach(candidate => {
                    if (candidate.customFields) {
                        candidate.customFields.forEach(field => {
                            allCustomFieldNames.add(field.name);
                        });
                    }
                });
                headers.push(...Array.from(allCustomFieldNames));

                // データ行作成
                const rows = results.map(candidate => {
                    const row = [
                        candidate.name,
                        candidate.positionName,
                        candidate.department,
                        candidate.hiringManager || '',
                        HIRING_ATTRIBUTES.find(a => a.value === candidate.hiringAttribute)?.label || '',
                        candidate.phaseName,
                        candidate.notes || '',
                        new Date(candidate.createdAt).toLocaleDateString()
                    ];

                    // カスタムフィールドの値を追加
                    Array.from(allCustomFieldNames).forEach(fieldName => {
                        const field = candidate.customFields?.find(f => f.name === fieldName);
                        row.push(field ? field.value : '');
                    });

                    return row;
                });

                // CSV文字列作成
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                // BOM付きでダウンロード（Excel対応）
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `候補者一覧_${new Date().toLocaleDateString()}.csv`;
                link.click();
            };

            // 候補者へナビゲート
            const handleNavigateToCandidate = (candidate) => {
                onNavigateToCandidate(candidate.positionId, candidate.phaseId, candidate.id);
                onClose();
            };

            // フィルタを適用
            const handleApplyFilter = () => {
                if (results.length === 0) {
                    alert('検索結果がありません。先に検索を実行してください。');
                    return;
                }
                
                const filteredCandidateIds = results.map(r => r.id);
                onApplyFilter(filteredCandidateIds);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-6xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                        <h3 className="text-lg font-semibold mb-4">候補者検索・抽出</h3>

                        <div className="space-y-4 mb-6">
                            {/* 基本検索 */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    名前・メモで検索
                                </label>
                                <input
                                    type="text"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    placeholder="候補者名またはメモの内容を入力"
                                    className="w-full border rounded-lg px-3 py-2"
                                />
                            </div>

                            {/* ポジション・フェーズフィルタ */}
                            <div className="grid grid-cols-3 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        ポジション
                                    </label>
                                    <select
                                        value={selectedPosition}
                                        onChange={(e) => setSelectedPosition(e.target.value)}
                                        className="w-full border rounded-lg px-3 py-2"
                                    >
                                        <option value="all">すべて</option>
                                        {positions.map(position => (
                                            <option key={position.id} value={position.id}>
                                                {position.name}
                                            </option>
                                        ))}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        フェーズ
                                    </label>
                                    <select
                                        value={selectedPhase}
                                        onChange={(e) => setSelectedPhase(e.target.value)}
                                        className="w-full border rounded-lg px-3 py-2"
                                    >
                                        <option value="all">すべて</option>
                                        {selectedPosition !== 'all' ? (
                                            positions.find(p => p.id === parseInt(selectedPosition))?.phases.map(phase => (
                                                <option key={phase.id} value={phase.id}>
                                                    {phase.name}
                                                </option>
                                            ))
                                        ) : (
                                            // 全ポジションから重複を除いたフェーズリスト
                                            Array.from(new Set(positions.flatMap(p => p.phases.map(ph => ph.name)))).map(phaseName => {
                                                const phase = positions[0].phases.find(ph => ph.name === phaseName);
                                                return phase ? (
                                                    <option key={phase.id} value={phase.id}>
                                                        {phase.name}
                                                    </option>
                                                ) : null;
                                            })
                                        )}
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        採用者属性
                                    </label>
                                    <select
                                        value={selectedAttribute}
                                        onChange={(e) => setSelectedAttribute(e.target.value)}
                                        className="w-full border rounded-lg px-3 py-2"
                                    >
                                        <option value="all">すべて</option>
                                        {HIRING_ATTRIBUTES.map(attr => (
                                            <option key={attr.value} value={attr.value}>
                                                {attr.label}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>

                            {/* カスタムフィールドフィルタ */}
                            <div className="border-t pt-4">
                                <div className="flex items-center justify-between mb-2">
                                    <h4 className="text-sm font-medium text-gray-700">カスタムフィールドで絞り込み</h4>
                                    {customFieldFilters.length > 1 && (
                                        <select
                                            value={filterLogic}
                                            onChange={(e) => setFilterLogic(e.target.value)}
                                            className="text-sm border rounded px-2 py-1"
                                        >
                                            <option value="AND">すべての条件を満たす（AND）</option>
                                            <option value="OR">いずれかの条件を満たす（OR）</option>
                                        </select>
                                    )}
                                </div>

                                <div className="space-y-2">
                                    {customFieldFilters.map((filter) => {
                                        const operators = filter.fieldName ? getOperatorsForField(filter.fieldName) : [];
                                        
                                        return (
                                            <div key={filter.id} className="flex items-center space-x-2">
                                                <select
                                                    value={filter.fieldName}
                                                    onChange={(e) => {
                                                        updateCustomFieldFilter(filter.id, { 
                                                            fieldName: e.target.value,
                                                            operator: 'equals' // フィールド変更時は演算子をリセット
                                                        });
                                                    }}
                                                    className="flex-1 border rounded px-2 py-1"
                                                >
                                                    <option value="">フィールドを選択</option>
                                                    {availableCustomFields.map(field => (
                                                        <option key={field.name} value={field.name}>
                                                            {field.name}
                                                        </option>
                                                    ))}
                                                </select>
                                                <select
                                                    value={filter.operator}
                                                    onChange={(e) => updateCustomFieldFilter(filter.id, { operator: e.target.value })}
                                                    className="border rounded px-2 py-1"
                                                >
                                                    {operators.map(op => (
                                                        <option key={op.value} value={op.value}>
                                                            {op.label}
                                                        </option>
                                                    ))}
                                                </select>
                                                <input
                                                    type="text"
                                                    value={filter.value}
                                                    onChange={(e) => updateCustomFieldFilter(filter.id, { value: e.target.value })}
                                                    placeholder={filter.operator === 'between' ? "最小値" : "値を入力"}
                                                    className="flex-1 border rounded px-2 py-1"
                                                />
                                                {filter.operator === 'between' && (
                                                    <input
                                                        type="text"
                                                        value={filter.value2 || ''}
                                                        onChange={(e) => updateCustomFieldFilter(filter.id, { value2: e.target.value })}
                                                        placeholder="最大値"
                                                        className="flex-1 border rounded px-2 py-1"
                                                    />
                                                )}
                                                <button
                                                    onClick={() => removeCustomFieldFilter(filter.id)}
                                                    className="text-red-500 hover:text-red-600 p-1"
                                                >
                                                    <X />
                                                </button>
                                            </div>
                                        );
                                    })}
                                </div>

                                <button
                                    onClick={addCustomFieldFilter}
                                    className="mt-2 text-sm text-blue-500 hover:text-blue-600"
                                >
                                    + カスタムフィールドの条件を追加
                                </button>
                            </div>
                        </div>

                        {/* 検索ボタン */}
                        <div className="flex justify-center mb-6">
                            <button
                                onClick={executeSearch}
                                className="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center space-x-2"
                            >
                                <Search />
                                <span>検索実行</span>
                            </button>
                        </div>

                        {/* 検索結果 */}
                        {showResults && (
                            <div className="border-t pt-4">
                                <div className="flex items-center justify-between mb-4">
                                    <h4 className="font-medium">
                                        検索結果: {results.length}件
                                    </h4>
                                    <div className="flex items-center space-x-2">
                                        {results.length > 0 && onApplyFilter && (
                                            <button
                                                onClick={handleApplyFilter}
                                                className="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 text-sm"
                                            >
                                                <Filter />
                                                <span>この条件で絞り込む</span>
                                            </button>
                                        )}
                                        {results.length > 0 && (
                                            <button
                                                onClick={exportToCSV}
                                                className="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2 text-sm"
                                            >
                                                <Download />
                                                <span>CSVダウンロード</span>
                                            </button>
                                        )}
                                    </div>
                                </div>

                                {results.length > 0 ? (
                                    <div className="max-h-96 overflow-y-auto">
                                        <table className="w-full text-sm">
                                            <thead className="bg-gray-50 sticky top-0">
                                                <tr>
                                                    <th className="px-4 py-2 text-left">候補者名</th>
                                                    <th className="px-4 py-2 text-left">ポジション</th>
                                                    <th className="px-4 py-2 text-left">フェーズ</th>
                                                    <th className="px-4 py-2 text-left">採用者属性</th>
                                                    <th className="px-4 py-2 text-left">登録日</th>
                                                    <th className="px-4 py-2 text-center">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {results.map((candidate, index) => (
                                                    <tr key={`${candidate.id}-${index}`} className="border-b hover:bg-gray-50">
                                                        <td className="px-4 py-2 font-medium">{candidate.name}</td>
                                                        <td className="px-4 py-2">{candidate.positionName}</td>
                                                        <td className="px-4 py-2">{candidate.phaseName}</td>
                                                        <td className="px-4 py-2">
                                                            {HIRING_ATTRIBUTES.find(a => a.value === candidate.hiringAttribute)?.label || '-'}
                                                        </td>
                                                        <td className="px-4 py-2">
                                                            {new Date(candidate.createdAt).toLocaleDateString()}
                                                        </td>
                                                        <td className="px-4 py-2 text-center">
                                                            <button
                                                                onClick={() => handleNavigateToCandidate(candidate)}
                                                                className="text-blue-500 hover:text-blue-600 inline-flex items-center space-x-1"
                                                            >
                                                                <Eye />
                                                                <span>表示</span>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div className="text-center text-gray-500 py-8">
                                        該当する候補者が見つかりませんでした
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="flex justify-end mt-6">
                            <button
                                onClick={onClose}
                                className="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg"
                            >
                                閉じる
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // フェーズ管理モーダル（変更なし）
        const PhaseManagementModal = ({ isOpen, phases, onUpdate, onClose }) => {
            const [editedPhases, setEditedPhases] = useState([]);
            const [newPhase, setNewPhase] = useState({ name: '', color: 'bg-blue-500' });
            const [draggedIndex, setDraggedIndex] = useState(null);
            const [dragOverIndex, setDragOverIndex] = useState(null);

            useEffect(() => {
                if (isOpen && phases) {
                    setEditedPhases(phases.map(p => ({ ...p })));
                }
            }, [isOpen, phases]);

            if (!isOpen) return null;

            const handlePhaseUpdate = (index, updates) => {
                const updated = [...editedPhases];
                updated[index] = { ...updated[index], ...updates };
                setEditedPhases(updated);
            };

            const handleAddPhase = () => {
                if (!newPhase.name.trim()) return;
                
                const phase = {
                    id: `phase_${Date.now()}`,
                    name: newPhase.name.trim(),
                    color: newPhase.color,
                    candidates: []
                };
                
                setEditedPhases([...editedPhases, phase]);
                setNewPhase({ name: '', color: 'bg-blue-500' });
            };

            const handleDeletePhase = (index) => {
                const phase = editedPhases[index];
                if (phase.candidates && phase.candidates.length > 0) {
                    if (!confirm(`「${phase.name}」には${phase.candidates.length}名の候補者がいます。本当に削除しますか？`)) {
                        return;
                    }
                }
                
                const updated = editedPhases.filter((_, i) => i !== index);
                setEditedPhases(updated);
            };

            const handleDragStart = (e, index) => {
                setDraggedIndex(index);
                e.dataTransfer.effectAllowed = 'move';
            };

            const handleDragOver = (e, index) => {
                e.preventDefault();
                setDragOverIndex(index);
            };

            const handleDragLeave = () => {
                setDragOverIndex(null);
            };

            const handleDrop = (e, dropIndex) => {
                e.preventDefault();
                if (draggedIndex === null || draggedIndex === dropIndex) return;

                const draggedPhase = editedPhases[draggedIndex];
                const newPhases = [...editedPhases];
                
                // Remove dragged item
                newPhases.splice(draggedIndex, 1);
                
                // Insert at new position
                const adjustedDropIndex = draggedIndex < dropIndex ? dropIndex - 1 : dropIndex;
                newPhases.splice(adjustedDropIndex, 0, draggedPhase);
                
                setEditedPhases(newPhases);
                setDraggedIndex(null);
                setDragOverIndex(null);
            };

            const movePhase = (index, direction) => {
                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= editedPhases.length) return;

                const newPhases = [...editedPhases];
                const temp = newPhases[index];
                newPhases[index] = newPhases[newIndex];
                newPhases[newIndex] = temp;
                
                setEditedPhases(newPhases);
            };

            const handleSave = () => {
                onUpdate(editedPhases);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-3xl w-full mx-4 max-h-[80vh] overflow-y-auto">
                        <h3 className="text-lg font-semibold mb-4">フェーズ管理</h3>
                        
                        <div className="space-y-2 mb-6">
                            {editedPhases.map((phase, index) => (
                                <div 
                                    key={phase.id} 
                                    className={`flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-move ${
                                        draggedIndex === index ? 'dragging' : ''
                                    } ${
                                        dragOverIndex === index ? 'drag-over' : ''
                                    }`}
                                    draggable
                                    onDragStart={(e) => handleDragStart(e, index)}
                                    onDragOver={(e) => handleDragOver(e, index)}
                                    onDragLeave={handleDragLeave}
                                    onDrop={(e) => handleDrop(e, index)}
                                >
                                    <div className="cursor-move text-gray-400">
                                        <GripVertical />
                                    </div>
                                    <div className={`w-4 h-4 rounded-full ${phase.color}`}></div>
                                    <input
                                        type="text"
                                        value={phase.name}
                                        onChange={(e) => handlePhaseUpdate(index, { name: e.target.value })}
                                        className="flex-1 border rounded px-2 py-1"
                                    />
                                    <select
                                        value={phase.color}
                                        onChange={(e) => handlePhaseUpdate(index, { color: e.target.value })}
                                        className="border rounded px-2 py-1"
                                    >
                                        {AVAILABLE_COLORS.map(color => (
                                            <option key={color.value} value={color.value}>
                                                {color.label}
                                            </option>
                                        ))}
                                    </select>
                                    <div className="flex items-center space-x-1">
                                        <button
                                            onClick={() => movePhase(index, -1)}
                                            disabled={index === 0}
                                            className="text-gray-400 hover:text-gray-600 disabled:opacity-30 p-1"
                                        >
                                            <ChevronUp />
                                        </button>
                                        <button
                                            onClick={() => movePhase(index, 1)}
                                            disabled={index === editedPhases.length - 1}
                                            className="text-gray-400 hover:text-gray-600 disabled:opacity-30 p-1"
                                        >
                                            <ChevronDown />
                                        </button>
                                    </div>
                                    <button
                                        onClick={() => handleDeletePhase(index)}
                                        className="text-red-500 hover:text-red-600 p-1"
                                    >
                                        <Trash2 />
                                    </button>
                                    {phase.candidates && phase.candidates.length > 0 && (
                                        <span className="text-xs text-gray-500">
                                            {phase.candidates.length}名
                                        </span>
                                    )}
                                </div>
                            ))}
                        </div>

                        <div className="border-t pt-4">
                            <h4 className="text-sm font-medium mb-2">新しいフェーズを追加</h4>
                            <div className="flex items-center space-x-2">
                                <input
                                    type="text"
                                    value={newPhase.name}
                                    onChange={(e) => setNewPhase({ ...newPhase, name: e.target.value })}
                                    placeholder="フェーズ名"
                                    className="flex-1 border rounded px-2 py-1"
                                    onKeyPress={(e) => e.key === 'Enter' && handleAddPhase()}
                                />
                                <div className="flex items-center space-x-2 border rounded px-2 py-1">
                                    <div className={`w-4 h-4 rounded-full ${newPhase.color}`}></div>
                                    <select
                                        value={newPhase.color}
                                        onChange={(e) => setNewPhase({ ...newPhase, color: e.target.value })}
                                        className="border-none outline-none"
                                    >
                                        {AVAILABLE_COLORS.map(color => (
                                            <option key={color.value} value={color.value}>
                                                {color.label}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <button
                                    onClick={handleAddPhase}
                                    className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded"
                                >
                                    追加
                                </button>
                            </div>
                        </div>

                        <div className="mt-4 text-xs text-gray-500">
                            ※ フェーズはドラッグ&ドロップで並び替えできます
                        </div>

                        <div className="flex space-x-2 mt-6">
                            <button
                                onClick={onClose}
                                className="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg"
                            >
                                キャンセル
                            </button>
                            <button
                                onClick={handleSave}
                                className="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
                            >
                                保存
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 接続ステータス表示コンポーネント（変更なし）
        const ConnectionStatus = ({ dbManager, dataSource, lastUpdate }) => {
            const [status, setStatus] = useState(dbManager.getConnectionStatus());

            useEffect(() => {
                const updateStatus = () => setStatus(dbManager.getConnectionStatus());
                
                window.addEventListener('online', updateStatus);
                window.addEventListener('offline', updateStatus);
                
                return () => {
                    window.removeEventListener('online', updateStatus);
                    window.removeEventListener('offline', updateStatus);
                };
            }, [dbManager]);

            const getStatusColor = () => {
                if (!status.isOnline) return 'bg-red-100 text-red-800';
                if (status.pendingSync) return 'bg-yellow-100 text-yellow-800';
                return 'bg-green-100 text-green-800';
            };

            const getStatusText = () => {
                if (!status.isOnline) return 'オフライン（ローカル保存のみ）';
                if (status.pendingSync) return 'オンライン（同期待ち）';
                return 'オンライン（同期済み）';
            };

            return (
                <div className="fixed bottom-4 left-4 z-50">
                    <div className={`flex items-center space-x-2 px-3 py-2 rounded-lg text-sm ${getStatusColor()}`}>
                        {status.isOnline ? <Wifi /> : <WifiOff />}
                        <span>{getStatusText()}</span>
                    </div>
                    {dataSource && (
                        <div className="text-xs text-gray-500 mt-1 px-3">
                            データ: {dataSource === 'remote' ? 'チーム共有' : dataSource === 'local' ? 'ローカル' : '初期設定'}
                            {lastUpdate && ` (${new Date(lastUpdate).toLocaleString()})`}
                        </div>
                    )}
                </div>
            );
        };

        // ログインコンポーネント（変更なし）
        const LoginComponent = ({ onLogin }) => {
            const [password, setPassword] = useState('');
            
            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === 'salowin2025') {
                    onLogin();
                } else {
                    alert('パスワードが正しくありません');
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <div className="bg-white p-8 rounded-lg shadow-md max-w-md w-full">
                        <h2 className="text-2xl font-bold mb-6 text-center">SALOWIN ATS</h2>
                        <p className="text-gray-600 mb-4 text-center">サロウィン社内専用<br/>パスワードを入力してください</p>
                        <form onSubmit={handleSubmit}>
                            <input
                                type="password"
                                placeholder="パスワードを入力"
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                className="w-full border rounded-lg px-4 py-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                            />
                            <button 
                                type="submit"
                                className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-medium"
                            >
                                ログイン
                            </button>
                        </form>
                        <div className="mt-4 text-xs text-gray-500 text-center">
                            チーム全体でデータを共有します
                        </div>
                    </div>
                </div>
            );
        };

        // 候補者詳細モーダル（数値フォーマット対応版）
        const CandidateDetailModal = ({ 
          isOpen, 
          candidate, 
          phaseId, 
          onUpdate, 
          onClose 
        }) => {
          const [editData, setEditData] = useState({
            name: candidate?.name || '',
            notes: candidate?.notes || '',
            customFields: candidate?.customFields || []
          });
          const [newFieldName, setNewFieldName] = useState('');
          const [editingFieldIndex, setEditingFieldIndex] = useState(null);

          React.useEffect(() => {
            if (candidate) {
              setEditData({
                name: candidate.name || '',
                notes: candidate.notes || '',
                customFields: candidate.customFields || []
              });
            }
          }, [candidate]);

          if (!isOpen || !candidate) return null;

          const handleSave = () => {
            const updatedData = {
              ...editData,
              updatedAt: new Date().toISOString()
            };
            onUpdate(phaseId, candidate.id, updatedData);
            onClose();
          };

          const handleAddField = () => {
            if (!newFieldName.trim()) return;
            
            const newField = {
              id: Date.now(),
              name: newFieldName.trim(),
              value: '',
              isNumeric: false
            };
            
            setEditData({
              ...editData,
              customFields: [...editData.customFields, newField]
            });
            setNewFieldName('');
          };

          const handleUpdateField = (index, updates) => {
            const updatedFields = [...editData.customFields];
            updatedFields[index] = { ...updatedFields[index], ...updates };
            setEditData({ ...editData, customFields: updatedFields });
          };

          const handleFieldValueChange = (index, value) => {
            const field = editData.customFields[index];
            
            // 数値かどうかを判定
            const numericOnly = value.replace(/[^\d]/g, '');
            const isNumeric = numericOnly.length > 0 && value.replace(/,/g, '') === numericOnly;
            
            if (isNumeric) {
              // 数値の場合はフォーマット
              const formatted = formatNumber(value);
              handleUpdateField(index, { value: formatted, isNumeric: true });
            } else {
              // 数値でない場合はそのまま
              handleUpdateField(index, { value: value, isNumeric: false });
            }
          };

          const handleDeleteField = (index) => {
            const updatedFields = editData.customFields.filter((_, i) => i !== index);
            setEditData({ ...editData, customFields: updatedFields });
          };

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <h3 className="text-lg font-semibold mb-4">候補者詳細編集</h3>
                
                {/* 基本情報 */}
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      候補者名
                    </label>
                    <input
                      type="text"
                      value={editData.name}
                      onChange={(e) => setEditData({ ...editData, name: e.target.value })}
                      className="w-full border rounded-lg px-3 py-2"
                    />
                  </div>

                  {/* カスタムフィールド */}
                  <div className="border-t pt-4">
                    <h4 className="text-sm font-medium text-gray-700 mb-3">カスタムフィールド</h4>
                    
                    <div className="space-y-2 mb-4">
                      {editData.customFields.map((field, index) => (
                        <div key={field.id} className="flex items-start space-x-2">
                          {editingFieldIndex === index ? (
                            <input
                              type="text"
                              value={field.name}
                              onChange={(e) => handleUpdateField(index, { name: e.target.value })}
                              onBlur={() => setEditingFieldIndex(null)}
                              onKeyPress={(e) => e.key === 'Enter' && setEditingFieldIndex(null)}
                              className="w-32 border rounded px-2 py-1 text-sm"
                              autoFocus
                            />
                          ) : (
                            <label 
                              className="w-32 text-sm text-gray-600 py-1 cursor-pointer hover:text-gray-800"
                              onClick={() => setEditingFieldIndex(index)}
                            >
                              {field.name}
                            </label>
                          )}
                          <input
                            type="text"
                            value={field.value}
                            onChange={(e) => handleFieldValueChange(index, e.target.value)}
                            className="flex-1 border rounded px-2 py-1"
                            placeholder={field.isNumeric ? "数値を入力（自動で桁区切り）" : "値を入力"}
                          />
                          <button
                            onClick={() => handleDeleteField(index)}
                            className="text-red-500 hover:text-red-600 p-1"
                          >
                            <X />
                          </button>
                        </div>
                      ))}
                    </div>

                    <div className="flex items-center space-x-2">
                      <input
                        type="text"
                        value={newFieldName}
                        onChange={(e) => setNewFieldName(e.target.value)}
                        placeholder="フィールド名"
                        className="flex-1 border rounded px-2 py-1"
                        onKeyPress={(e) => e.key === 'Enter' && handleAddField()}
                      />
                      <button
                        onClick={handleAddField}
                        className="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm"
                      >
                        フィールド追加
                      </button>
                    </div>
                    <div className="mt-2 text-xs text-gray-500">
                      ※ 数値を入力すると自動的に桁区切りが適用されます
                    </div>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      メモ・詳細情報
                    </label>
                    <textarea
                      value={editData.notes}
                      onChange={(e) => setEditData({ ...editData, notes: e.target.value })}
                      className="w-full border rounded-lg px-3 py-2 h-32 resize-none"
                      placeholder="候補者に関するメモや詳細情報を入力してください..."
                    />
                  </div>

                  {/* 日時情報 */}
                  <div className="border-t pt-4 space-y-2">
                    <div className="flex items-center text-xs text-gray-500">
                      <Calendar className="mr-1" />
                      <strong>登録日時:</strong>
                      <span className="ml-1">{new Date(candidate.createdAt).toLocaleString()}</span>
                    </div>
                    {candidate.updatedAt && (
                      <div className="flex items-center text-xs text-gray-500">
                        <Clock className="mr-1" />
                        <strong>最終更新日時:</strong>
                        <span className="ml-1">{new Date(candidate.updatedAt).toLocaleString()}</span>
                      </div>
                    )}
                  </div>

                  {/* 移動履歴表示 */}
                  {candidate.history && candidate.history.length > 0 && (
                    <div className="border-t pt-4">
                      <h4 className="text-sm font-medium text-gray-700 mb-2 flex items-center">
                        <History className="mr-1" />
                        フェーズ移動履歴
                      </h4>
                      <div className="space-y-2 max-h-40 overflow-y-auto">
                        {candidate.history.map((entry, index) => (
                          <div key={index} className="text-xs bg-gray-50 p-2 rounded">
                            <div className="font-medium text-gray-700">
                              {new Date(entry.timestamp).toLocaleString()}
                            </div>
                            <div className="text-gray-600">
                              {entry.fromPhase} → {entry.toPhase}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </div>
                
                <div className="flex space-x-2 mt-6">
                  <button
                    onClick={onClose}
                    className="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg"
                  >
                    キャンセル
                  </button>
                  <button
                    onClick={handleSave}
                    className="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
                  >
                    保存
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // 候補者カード（フィルタ対応版）
        const CandidateCard = ({ 
          candidate, 
          phaseId, 
          onUpdateCandidate,
          onMoveCandidate,
          onDeleteCandidate,
          selectedCandidate,
          onCandidateClick,
          onOpenDetail,
          phases,
          isHighlighted,
          candidateRef
        }) => {
          const [showMenu, setShowMenu] = useState(false);
          const [isEditing, setIsEditing] = useState(false);
          const [showAllFields, setShowAllFields] = useState(false);
          const isSelected = selectedCandidate?.id === candidate.id;

          // クイック移動ボタンの表示制御
          const getQuickMoveButtons = () => {
            const buttons = [];
            
            // 現在のフェーズに応じて適切なボタンを表示
            const offerPhase = phases.find(p => p.id === 'offer' || p.name.includes('内定'));
            const hiredPhase = phases.find(p => p.id === 'hired' || p.name.includes('採用決定'));
            const declinedPhase = phases.find(p => p.id === 'declined' || p.name.includes('辞退'));
            const rejectedPhase = phases.find(p => p.id === 'rejected' || p.name.includes('不合格'));

            if (offerPhase && phaseId !== offerPhase.id) {
              buttons.push({
                label: offerPhase.name,
                phaseId: offerPhase.id,
                color: 'bg-green-500 hover:bg-green-600'
              });
            }

            if (hiredPhase && phaseId !== hiredPhase.id) {
              buttons.push({
                label: hiredPhase.name,
                phaseId: hiredPhase.id,
                color: 'bg-emerald-500 hover:bg-emerald-600'
              });
            }

            if (declinedPhase && phaseId !== declinedPhase.id) {
              buttons.push({
                label: declinedPhase.name,
                phaseId: declinedPhase.id,
                color: 'bg-orange-500 hover:bg-orange-600'
              });
            }

            if (rejectedPhase && phaseId !== rejectedPhase.id) {
              buttons.push({
                label: rejectedPhase.name,
                phaseId: rejectedPhase.id,
                color: 'bg-red-500 hover:bg-red-600'
              });
            }

            return buttons;
          };

          const quickMoveButtons = getQuickMoveButtons();

          return (
            <div 
              ref={candidateRef}
              className={`bg-white rounded-lg shadow-sm border-2 p-3 mb-2 hover:shadow-md transition-all relative cursor-pointer ${
                isSelected ? 'border-blue-400 bg-blue-50' : 'border-gray-200'
              } ${isHighlighted ? 'highlight-candidate' : ''}`}
              draggable={isSelected}
              onClick={(e) => {
                e.stopPropagation();
                onCandidateClick(candidate);
              }}
              onDoubleClick={(e) => {
                e.stopPropagation();
                onOpenDetail(candidate);
              }}
              onDragStart={(e) => {
                if (isSelected) {
                  e.dataTransfer.setData('text/plain', JSON.stringify({
                    candidateId: candidate.id,
                    fromPhaseId: phaseId
                  }));
                  e.dataTransfer.effectAllowed = 'move';
                } else {
                  e.preventDefault();
                }
              }}
            >
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center space-x-2">
                  <div className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center">
                    <User />
                  </div>
                  <div>
                    {isEditing ? (
                      <input
                        type="text"
                        value={candidate.name}
                        onChange={(e) => onUpdateCandidate(phaseId, candidate.id, { name: e.target.value })}
                        className="font-medium text-sm border rounded px-1"
                        onBlur={() => setIsEditing(false)}
                        onKeyPress={(e) => e.key === 'Enter' && setIsEditing(false)}
                        onClick={(e) => e.stopPropagation()}
                        autoFocus
                      />
                    ) : (
                      <div className="font-medium text-sm text-gray-800">{candidate.name}</div>
                    )}
                  </div>
                </div>
                
                <div className="flex items-center space-x-2">
                  {isSelected && (
                    <span className="text-xs text-blue-600 font-medium">選択中</span>
                  )}
                  <div className="relative">
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        setShowMenu(!showMenu);
                      }}
                      className="text-gray-400 hover:text-gray-600 p-1"
                    >
                      <MoreHorizontal />
                    </button>
                    
                    {showMenu && (
                      <div className="absolute right-0 top-6 bg-white border rounded-lg shadow-lg z-10 py-1 min-w-32">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            onOpenDetail(candidate);
                            setShowMenu(false);
                          }}
                          className="w-full text-left px-3 py-1 text-sm hover:bg-gray-100 flex items-center space-x-2"
                        >
                          <Edit3 />
                          <span>詳細編集</span>
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setIsEditing(true);
                            setShowMenu(false);
                          }}
                          className="w-full text-left px-3 py-1 text-sm hover:bg-gray-100 flex items-center space-x-2"
                        >
                          <Edit3 />
                          <span>名前編集</span>
                        </button>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            if (confirm(`${candidate.name}さんを削除しますか？`)) {
                              onDeleteCandidate(phaseId, candidate.id);
                            }
                            setShowMenu(false);
                          }}
                          className="w-full text-left px-3 py-1 text-sm hover:bg-gray-100 text-red-600 flex items-center space-x-2"
                        >
                          <Trash2 />
                          <span>削除</span>
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              {candidate.customFields && candidate.customFields.length > 0 && (
                <div className="text-xs text-gray-500 mb-2">
                  {(showAllFields ? candidate.customFields : candidate.customFields.slice(0, 5)).map((field) => (
                    <div key={field.id} className="truncate">
                      <span className="font-medium">{field.name}:</span> {field.value}
                    </div>
                  ))}
                  {candidate.customFields.length > 5 && !showAllFields && (
                    <button 
                      onClick={(e) => {
                        e.stopPropagation();
                        setShowAllFields(true);
                      }}
                      className="text-blue-500 hover:text-blue-600 mt-1"
                    >
                      他{candidate.customFields.length - 5}件...
                    </button>
                  )}
                  {showAllFields && candidate.customFields.length > 5 && (
                    <button 
                      onClick={(e) => {
                        e.stopPropagation();
                        setShowAllFields(false);
                      }}
                      className="text-blue-500 hover:text-blue-600 mt-1"
                    >
                      折りたたむ
                    </button>
                  )}
                </div>
              )}

              {quickMoveButtons.length > 0 && (
                <div className="flex items-center space-x-1 flex-wrap gap-1 mb-2">
                  {quickMoveButtons.map((button) => (
                    <button
                      key={button.phaseId}
                      onClick={(e) => {
                        e.stopPropagation();
                        onMoveCandidate(candidate.id, phaseId, button.phaseId);
                      }}
                      className={`text-xs ${button.color} text-white px-2 py-1 rounded`}
                    >
                      {button.label}
                    </button>
                  ))}
                </div>
              )}

              <div className="flex items-center justify-between text-xs text-gray-400">
                <div className="flex items-center">
                  <Clock />
                  <span className="ml-1">{new Date(candidate.createdAt).toLocaleDateString()}</span>
                </div>
                <div className="text-blue-500">
                  {isSelected && <span>（ドラッグ可能）</span>}
                  <span className="ml-1">ダブルクリックで詳細</span>
                </div>
              </div>
            </div>
          );
        };

        // ポジション追加モーダル（変更なし）
        const AddPositionModal = ({ isOpen, newPosition, onPositionChange, onAdd, onCancel }) => {
          if (!isOpen) return null;

          return (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 className="text-lg font-semibold mb-4">新しい採用ポジションを追加</h3>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      採用ポジション
                    </label>
                    <input
                      type="text"
                      value={newPosition.name}
                      onChange={(e) => onPositionChange({ ...newPosition, name: e.target.value })}
                      className="w-full border rounded-lg px-3 py-2"
                      placeholder="例：ネイル本部人員（セールス＆CS）"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      採用事業部
                    </label>
                    <input
                      type="text"
                      value={newPosition.department}
                      onChange={(e) => onPositionChange({ ...newPosition, department: e.target.value })}
                      className="w-full border rounded-lg px-3 py-2"
                      placeholder="例：リテール事業部"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      採用責任者
                    </label>
                    <input
                      type="text"
                      value={newPosition.hiringManager}
                      onChange={(e) => onPositionChange({ ...newPosition, hiringManager: e.target.value })}
                      className="w-full border rounded-lg px-3 py-2"
                      placeholder="例：田中マネージャー"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                      採用者属性
                    </label>
                    <select
                      value={newPosition.hiringAttribute}
                      onChange={(e) => onPositionChange({ ...newPosition, hiringAttribute: e.target.value })}
                      className="w-full border rounded-lg px-3 py-2"
                    >
                      {HIRING_ATTRIBUTES.map(attr => (
                        <option key={attr.value} value={attr.value}>
                          {attr.label}
                        </option>
                      ))}
                    </select>
                  </div>
                </div>
                <div className="flex space-x-2 mt-6">
                  <button
                    onClick={onCancel}
                    className="flex-1 bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg"
                  >
                    キャンセル
                  </button>
                  <button
                    onClick={onAdd}
                    className="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
                  >
                    追加
                  </button>
                </div>
              </div>
            </div>
          );
        };

        // 採用管理システム（改良版）
        const RecruitmentSystem = () => {
            const [dbManager] = useState(() => new DatabaseManager());
            const [navigationHistory] = useState(() => new NavigationHistory());
            const [positions, setPositions] = useState([]);
            const [dataSource, setDataSource] = useState(null);
            const [lastUpdate, setLastUpdate] = useState(null);
            const [selectedPosition, setSelectedPosition] = useState(null);
            const [selectedCandidate, setSelectedCandidate] = useState(null);
            const [newTaskInputs, setNewTaskInputs] = useState({});
            const [editingPosition, setEditingPosition] = useState(null);
            const [showAddPosition, setShowAddPosition] = useState(false);
            const [showPhaseManagement, setShowPhaseManagement] = useState(false);
            const [showFilterModal, setShowFilterModal] = useState(false);
            const [filteredCandidateIds, setFilteredCandidateIds] = useState(null);
            const [highlightedCandidateId, setHighlightedCandidateId] = useState(null);
            const candidateRefs = useRef({});
            const [newPosition, setNewPosition] = useState({
                name: '',
                department: '',
                hiringManager: '',
                hiringAttribute: 'none'
            });

            const [detailModalOpen, setDetailModalOpen] = useState(false);
            const [detailEditingCandidate, setDetailEditingCandidate] = useState(null);
            const [detailEditingPhase, setDetailEditingPhase] = useState(null);

            // 初期データ読み込み
            useEffect(() => {
                const loadInitialData = async () => {
                    const result = await dbManager.loadData();
                    setPositions(result.data);
                    setDataSource(result.source);
                    setLastUpdate(result.timestamp);
                };
                loadInitialData();
            }, [dbManager]);

            // データを保存
            const saveData = useCallback(async (data) => {
                const result = await dbManager.saveData(data);
                if (result.success) {
                    setLastUpdate(new Date().toISOString());
                    if (result.error) {
                        // リモート保存失敗の場合は警告表示（オプション）
                        console.warn('Remote save failed, saved locally:', result.error);
                    }
                }
            }, [dbManager]);

            // 定期的にリモートデータをチェック（オプション）
            useEffect(() => {
                const interval = setInterval(async () => {
                    if (navigator.onLine) {
                        try {
                            const result = await dbManager.loadData();
                            if (result.source === 'remote' && result.timestamp !== lastUpdate) {
                                setPositions(result.data);
                                setLastUpdate(result.timestamp);
                            }
                        } catch (error) {
                            console.log('Periodic sync failed:', error);
                        }
                    }
                }, 30000); // 30秒ごと

                return () => clearInterval(interval);
            }, [dbManager, lastUpdate]);

            // ナビゲーション管理
            const handlePositionSelect = useCallback((position) => {
                // 選択されたポジションの詳細を履歴に保存
                navigationHistory.push({
                    type: 'position-detail',
                    id: position.id,
                    name: position.name
                });
                
                setSelectedPosition(position);
                setSelectedCandidate(null);
                setFilteredCandidateIds(null); // フィルタをリセット
            }, [navigationHistory]);

            // ポジション一覧に戻る（統合版）
            const handleBackToPositionList = useCallback(() => {
                navigationHistory.clear();
                setSelectedPosition(null);
                setSelectedCandidate(null);
                setHighlightedCandidateId(null);
                setFilteredCandidateIds(null);
            }, [navigationHistory]);

            // 候補者へナビゲート
            const handleNavigateToCandidate = useCallback((positionId, phaseId, candidateId) => {
                const position = positions.find(p => p.id === positionId);
                if (position) {
                    setSelectedPosition(position);
                    setHighlightedCandidateId(candidateId);
                    
                    // 少し遅延を入れてからスクロール
                    setTimeout(() => {
                        if (candidateRefs.current[candidateId]) {
                            candidateRefs.current[candidateId].scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });
                        }
                        
                        // ハイライトを3秒後に削除
                        setTimeout(() => {
                            setHighlightedCandidateId(null);
                        }, 3000);
                    }, 100);
                }
            }, [positions]);

            // フィルタを適用
            const handleApplyFilter = useCallback((candidateIds) => {
                setFilteredCandidateIds(candidateIds);
            }, []);

            // フィルタをクリア
            const clearFilter = useCallback(() => {
                setFilteredCandidateIds(null);
            }, []);

            // 候補者選択
            const handleCandidateClick = useCallback((candidate) => {
                setSelectedCandidate(prev => prev?.id === candidate.id ? null : candidate);
            }, []);

            // 詳細モーダルを開く
            const openCandidateDetail = useCallback((candidate) => {
                const phase = selectedPosition.phases.find(p => 
                    p.candidates.some(c => c.id === candidate.id)
                );
                setDetailEditingCandidate(candidate);
                setDetailEditingPhase(phase.id);
                setDetailModalOpen(true);
            }, [selectedPosition]);

            // 候補者を追加
            const addCandidate = useCallback((phaseId, candidateName) => {
                if (!candidateName.trim() || !selectedPosition) return;

                const newCandidate = {
                    id: `pos${selectedPosition.id}-${phaseId}-${Date.now()}`,
                    name: candidateName.trim(),
                    notes: '',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    history: [], // 履歴を初期化
                    customFields: [] // カスタムフィールドを初期化
                };

                const updatedPositions = positions.map(position => {
                    if (position.id === selectedPosition.id) {
                        const updatedPosition = {
                            ...position,
                            phases: position.phases.map(phase => 
                                phase.id === phaseId 
                                    ? { ...phase, candidates: [...phase.candidates, newCandidate] }
                                    : phase
                            )
                        };
                        setSelectedPosition(updatedPosition);
                        return updatedPosition;
                    }
                    return position;
                });

                setPositions(updatedPositions);
                saveData(updatedPositions);
            }, [selectedPosition, positions, saveData]);

            // 候補者を更新
            const updateCandidate = useCallback((phaseId, candidateId, updates) => {
                const updatedPositions = positions.map(position => {
                    if (position.id === selectedPosition?.id) {
                        const updatedPosition = {
                            ...position,
                            phases: position.phases.map(phase => 
                                phase.id === phaseId 
                                    ? {
                                        ...phase,
                                        candidates: phase.candidates.map(candidate => 
                                            candidate.id === candidateId 
                                                ? { ...candidate, ...updates }
                                                : candidate
                                        )
                                    }
                                    : phase
                            )
                        };
                        setSelectedPosition(updatedPosition);
                        return updatedPosition;
                    }
                    return position;
                });

                setPositions(updatedPositions);
                saveData(updatedPositions);
            }, [selectedPosition, positions, saveData]);

            // 候補者を移動（履歴付き）
            const moveCandidate = useCallback((candidateId, fromPhaseId, toPhaseId) => {
                const position = selectedPosition;
                const fromPhase = position.phases.find(p => p.id === fromPhaseId);
                const toPhase = position.phases.find(p => p.id === toPhaseId);
                const candidate = fromPhase.candidates.find(c => c.id === candidateId);
                
                if (!candidate || !fromPhase || !toPhase) return;

                // 履歴エントリを作成
                const historyEntry = {
                    timestamp: new Date().toISOString(),
                    fromPhase: fromPhase.name,
                    toPhase: toPhase.name
                };

                // 候補者に履歴を追加
                const updatedCandidate = {
                    ...candidate,
                    history: [...(candidate.history || []), historyEntry],
                    updatedAt: new Date().toISOString()
                };

                const updatedPositions = positions.map(pos => {
                    if (pos.id === selectedPosition.id) {
                        const updatedPosition = {
                            ...pos,
                            phases: pos.phases.map(phase => {
                                if (phase.id === fromPhaseId) {
                                    return { ...phase, candidates: phase.candidates.filter(c => c.id !== candidateId) };
                                } else if (phase.id === toPhaseId) {
                                    return { ...phase, candidates: [...phase.candidates, updatedCandidate] };
                                }
                                return phase;
                            })
                        };
                        setSelectedPosition(updatedPosition);
                        return updatedPosition;
                    }
                    return pos;
                });

                setPositions(updatedPositions);
                saveData(updatedPositions);
            }, [selectedPosition, positions, saveData]);

            // 候補者を削除
            const deleteCandidate = useCallback((phaseId, candidateId) => {
                const updatedPositions = positions.map(position => {
                    if (position.id === selectedPosition?.id) {
                        const updatedPosition = {
                            ...position,
                            phases: position.phases.map(phase => 
                                phase.id === phaseId 
                                    ? { ...phase, candidates: phase.candidates.filter(c => c.id !== candidateId) }
                                    : phase
                            )
                        };
                        setSelectedPosition(updatedPosition);
                        return updatedPosition;
                    }
                    return position;
                });

                setPositions(updatedPositions);
                saveData(updatedPositions);
                setSelectedCandidate(null);
            }, [selectedPosition, positions, saveData]);

            // フェーズを更新（ポジション個別）
            const updatePhases = useCallback((updatedPhases) => {
                if (!selectedPosition) return;

                const updatedPositions = positions.map(position => {
                    if (position.id === selectedPosition.id) {
                        const updatedPosition = {
                            ...position,
                            phases: updatedPhases
                        };
                        setSelectedPosition(updatedPosition);
                        return updatedPosition;
                    }
                    return position;
                });

                setPositions(updatedPositions);
                saveData(updatedPositions);
            }, [selectedPosition, positions, saveData]);

            // ポジションを追加
            const addPosition = useCallback(() => {
                if (!newPosition.name.trim() || !newPosition.department.trim()) return;

                const position = {
                    id: Date.now(),
                    name: newPosition.name.trim(),
                    department: newPosition.department.trim(),
                    hiringManager: newPosition.hiringManager.trim(),
                    hiringAttribute: newPosition.hiringAttribute,
                    phases: DEFAULT_RECRUITMENT_PHASES.map(phase => ({ ...phase, candidates: [] }))
                };

                const updatedPositions = [...positions, position];
                setPositions(updatedPositions);
                saveData(updatedPositions);
                setNewPosition({ name: '', department: '', hiringManager: '', hiringAttribute: 'none' });
                setShowAddPosition(false);
            }, [newPosition, positions, saveData]);

            // ポジションを更新
            const updatePosition = useCallback((positionId, updates) => {
                const updatedPositions = positions.map(pos => 
                    pos.id === positionId ? { ...pos, ...updates } : pos
                );
                setPositions(updatedPositions);
                saveData(updatedPositions);
                
                if (selectedPosition?.id === positionId) {
                    setSelectedPosition(prev => ({ ...prev, ...updates }));
                }
            }, [positions, selectedPosition, saveData]);

            // ポジションを削除
            const deletePosition = useCallback((positionId) => {
                const updatedPositions = positions.filter(pos => pos.id !== positionId);
                setPositions(updatedPositions);
                saveData(updatedPositions);
                
                if (selectedPosition?.id === positionId) {
                    setSelectedPosition(null);
                }
            }, [positions, selectedPosition, saveData]);

            // ポジションの統計を取得（動的にフェーズを処理）
            const getPositionStats = (position) => {
                const stats = {
                    totalCandidates: 0,
                    phaseStats: []
                };

                // 最初の10個のフェーズの統計を収集
                position.phases.slice(0, 10).forEach(phase => {
                    const count = phase.candidates.length;
                    stats.totalCandidates += count;
                    stats.phaseStats.push({
                        id: phase.id,
                        name: phase.name,
                        count: count,
                        color: phase.color
                    });
                });

                // 10個以上のフェーズがある場合は、残りの候補者数を合計
                if (position.phases.length > 10) {
                    const remainingCount = position.phases.slice(10).reduce((sum, phase) => sum + phase.candidates.length, 0);
                    stats.totalCandidates += remainingCount;
                }

                return stats;
            };

            // カンバンボード表示
            if (selectedPosition) {
                const totalCandidates = selectedPosition.phases.reduce((sum, phase) => sum + phase.candidates.length, 0);
                const filteredCount = filteredCandidateIds ? filteredCandidateIds.length : totalCandidates;

                return (
                    <div className="p-6 bg-gray-100 min-h-screen pt-20">
                        <ConnectionStatus 
                            dbManager={dbManager} 
                            dataSource={dataSource} 
                            lastUpdate={lastUpdate} 
                        />
                        
                        <div className="mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center space-x-2">
                                    <button
                                        onClick={handleBackToPositionList}
                                        className="flex items-center space-x-2 text-gray-600 hover:text-gray-800 bg-white hover:bg-gray-50 px-3 py-2 rounded-lg border border-gray-200 transition-colors"
                                    >
                                        <Home />
                                        <span className="text-sm">ポジション一覧に戻る</span>
                                    </button>
                                </div>
                                <div className="flex items-center space-x-2">
                                    {filteredCandidateIds && (
                                        <button
                                            onClick={clearFilter}
                                            className="flex items-center space-x-2 bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm"
                                        >
                                            <FilterX />
                                            <span>フィルタ解除</span>
                                        </button>
                                    )}
                                    <button
                                        onClick={() => setShowFilterModal(true)}
                                        className="flex items-center space-x-2 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-sm"
                                    >
                                        <Search />
                                        <span>候補者検索</span>
                                    </button>
                                    <button
                                        onClick={() => setShowPhaseManagement(true)}
                                        className="flex items-center space-x-2 bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg text-sm"
                                    >
                                        <Settings />
                                        <span>フェーズ管理</span>
                                    </button>
                                </div>
                            </div>
                            <div>
                                <h1 className="text-2xl font-bold text-gray-800">{selectedPosition.name}</h1>
                                <p className="text-gray-600">
                                    {selectedPosition.department} | 
                                    {filteredCandidateIds ? (
                                        <span className="text-purple-600 font-medium">
                                            {` フィルタ中: ${filteredCount}名 / ${totalCandidates}名`}
                                        </span>
                                    ) : (
                                        ` 総候補者数: ${totalCandidates}名`
                                    )}
                                </p>
                            </div>
                        </div>

                        <div className="flex gap-4 overflow-x-auto pb-4">
                            {selectedPosition.phases.map((phase) => {
                                const visibleCandidates = filteredCandidateIds 
                                    ? phase.candidates.filter(c => filteredCandidateIds.includes(c.id))
                                    : phase.candidates;

                                return (
                                    <div 
                                        key={phase.id} 
                                        className={`min-w-80 bg-gray-50 rounded-lg p-4 transition-all ${
                                            selectedCandidate ? 'border-2 border-dashed border-blue-300' : ''
                                        }`}
                                        onDragOver={(e) => {
                                            e.preventDefault();
                                            e.dataTransfer.dropEffect = 'move';
                                        }}
                                        onDragEnter={(e) => e.preventDefault()}
                                        onDrop={(e) => {
                                            e.preventDefault();
                                            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                                            if (data.candidateId && data.fromPhaseId !== phase.id) {
                                                moveCandidate(data.candidateId, data.fromPhaseId, phase.id);
                                                setSelectedCandidate(null);
                                            }
                                        }}
                                    >
                                        <div className="flex items-center justify-between mb-4">
                                            <div className="flex items-center space-x-2">
                                                <div className={`w-4 h-4 rounded-full ${phase.color}`}></div>
                                                <h2 className="font-semibold text-gray-800">{phase.name}</h2>
                                            </div>
                                            <span className="text-sm text-gray-500">
                                                {filteredCandidateIds && visibleCandidates.length !== phase.candidates.length
                                                    ? `${visibleCandidates.length} / ${phase.candidates.length}`
                                                    : phase.candidates.length
                                                }
                                            </span>
                                        </div>

                                        <div className="space-y-2 mb-4 max-h-96 overflow-y-auto">
                                            {visibleCandidates.map((candidate) => (
                                                <CandidateCard
                                                    key={candidate.id}
                                                    candidate={candidate}
                                                    phaseId={phase.id}
                                                    selectedCandidate={selectedCandidate}
                                                    onCandidateClick={handleCandidateClick}
                                                    onOpenDetail={openCandidateDetail}
                                                    onUpdateCandidate={updateCandidate}
                                                    onMoveCandidate={moveCandidate}
                                                    onDeleteCandidate={deleteCandidate}
                                                    phases={selectedPosition.phases}
                                                    isHighlighted={highlightedCandidateId === candidate.id}
                                                    candidateRef={(el) => candidateRefs.current[candidate.id] = el}
                                                />
                                            ))}
                                            {visibleCandidates.length === 0 && (
                                                <div className="flex items-center justify-center h-20 text-gray-400 text-sm">
                                                    {filteredCandidateIds && phase.candidates.length > 0
                                                        ? 'フィルタ条件に該当する候補者がいません'
                                                        : 'まだ候補者がいません'
                                                    }
                                                </div>
                                            )}
                                        </div>

                                        <div className="flex items-center space-x-2 text-gray-500">
                                            <Plus />
                                            <input
                                                type="text"
                                                placeholder="候補者を追加"
                                                value={newTaskInputs[phase.id] || ''}
                                                onChange={(e) => setNewTaskInputs(prev => ({ ...prev, [phase.id]: e.target.value }))}
                                                onKeyPress={(e) => {
                                                    if (e.key === 'Enter') {
                                                        addCandidate(phase.id, newTaskInputs[phase.id]);
                                                        setNewTaskInputs(prev => ({ ...prev, [phase.id]: '' }));
                                                    }
                                                }}
                                                className="flex-1 bg-transparent border-none outline-none placeholder-gray-400 text-sm"
                                            />
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        <PhaseManagementModal
                            isOpen={showPhaseManagement}
                            phases={selectedPosition.phases}
                            onUpdate={updatePhases}
                            onClose={() => setShowPhaseManagement(false)}
                        />

                        <CandidateDetailModal
                            isOpen={detailModalOpen}
                            candidate={detailEditingCandidate}
                            phaseId={detailEditingPhase}
                            onUpdate={updateCandidate}
                            onClose={() => {
                                setDetailModalOpen(false);
                                setDetailEditingCandidate(null);
                                setDetailEditingPhase(null);
                            }}
                        />

                        <CandidateFilterModal
                            isOpen={showFilterModal}
                            positions={positions}
                            currentPositionId={selectedPosition.id}
                            onClose={() => setShowFilterModal(false)}
                            onNavigateToCandidate={handleNavigateToCandidate}
                            onApplyFilter={handleApplyFilter}
                        />
                    </div>
                );
            }

            // メイン画面表示
            return (
                <div className="p-6 bg-gray-100 min-h-screen pt-20">
                    <ConnectionStatus 
                        dbManager={dbManager} 
                        dataSource={dataSource} 
                        lastUpdate={lastUpdate} 
                    />
                    
                    <div className="flex items-center justify-between mb-6">
                        <div className="flex items-center space-x-4">
                            <h1 className="text-2xl font-bold text-gray-800">SALOWIN ATS</h1>
                        </div>
                        <div className="flex items-center space-x-2">
                            <button
                                onClick={() => setShowFilterModal(true)}
                                className="flex items-center space-x-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg"
                            >
                                <Search />
                                <span>候補者検索</span>
                            </button>
                            <button
                                onClick={() => setShowAddPosition(true)}
                                className="flex items-center space-x-2 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
                            >
                                <Plus />
                                <span>新規ポジション追加</span>
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {positions.map((position) => {
                            const stats = getPositionStats(position);
                            const isEditing = editingPosition === position.id;
                            
                            return (
                                <div key={position.id} className="bg-white rounded-lg shadow-sm border p-6 hover:shadow-md transition-shadow relative">
                                    <div className="absolute top-4 right-4">
                                        <button
                                            onClick={(e) => {
                                                e.stopPropagation();
                                                setEditingPosition(prev => prev === position.id ? null : position.id);
                                            }}
                                            className="text-gray-400 hover:text-gray-600 p-1"
                                        >
                                            <MoreHorizontal />
                                        </button>
                                    </div>

                                    <div 
                                        className="cursor-pointer"
                                        onClick={() => !isEditing && handlePositionSelect(position)}
                                    >
                                        <div className="flex items-start space-x-3 mb-4">
                                            <div className="flex-1">
                                                {isEditing ? (
                                                    <div className="space-y-2">
                                                        <input
                                                            type="text"
                                                            value={position.name}
                                                            onChange={(e) => updatePosition(position.id, { name: e.target.value })}
                                                            className="w-full font-semibold text-gray-800 border rounded px-2 py-1"
                                                            onClick={(e) => e.stopPropagation()}
                                                        />
                                                        <input
                                                            type="text"
                                                            value={position.department}
                                                            onChange={(e) => updatePosition(position.id, { department: e.target.value })}
                                                            className="w-full text-sm text-gray-600 border rounded px-2 py-1"
                                                            onClick={(e) => e.stopPropagation()}
                                                        />
                                                        <input
                                                            type="text"
                                                            value={position.hiringManager}
                                                            onChange={(e) => updatePosition(position.id, { hiringManager: e.target.value })}
                                                            className="w-full text-sm text-gray-600 border rounded px-2 py-1"
                                                            placeholder="採用責任者を入力"
                                                            onClick={(e) => e.stopPropagation()}
                                                        />
                                                        <select
                                                            value={position.hiringAttribute}
                                                            onChange={(e) => updatePosition(position.id, { hiringAttribute: e.target.value })}
                                                            className="w-full text-sm text-gray-600 border rounded px-2 py-1"
                                                            onClick={(e) => e.stopPropagation()}
                                                        >
                                                            {HIRING_ATTRIBUTES.map(attr => (
                                                                <option key={attr.value} value={attr.value}>
                                                                    {attr.label}
                                                                </option>
                                                            ))}
                                                        </select>
                                                        <div className="flex space-x-2">
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    setEditingPosition(null);
                                                                }}
                                                                className="text-xs bg-green-500 text-white px-2 py-1 rounded"
                                                            >
                                                                保存
                                                            </button>
                                                            <button
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    if (confirm('このポジションを削除しますか？')) {
                                                                        deletePosition(position.id);
                                                                    }
                                                                }}
                                                                className="text-xs bg-red-500 text-white px-2 py-1 rounded"
                                                            >
                                                                削除
                                                            </button>
                                                        </div>
                                                    </div>
                                                ) : (
                                                    <div>
                                                        <h3 className="font-semibold text-gray-800 mb-1">{position.name}</h3>
                                                        <p className="text-sm text-gray-600 mb-1">{position.department}</p>
                                                        <div className="text-xs text-gray-500 mb-1">
                                                            <span className="font-medium">責任者:</span> {position.hiringManager || '未設定'}
                                                        </div>
                                                        <div className="text-xs text-gray-500">
                                                            <span className="font-medium">属性:</span> {HIRING_ATTRIBUTES.find(a => a.value === position.hiringAttribute)?.label}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {!isEditing && (
                                        <div className="space-y-3">
                                            <div className="text-center mb-2">
                                                <div className="text-2xl font-bold text-blue-600">{stats.totalCandidates}</div>
                                                <div className="text-sm text-gray-500">総候補者数</div>
                                            </div>
                                            <div className="grid grid-cols-5 gap-2 text-center">
                                                {stats.phaseStats.slice(0, 5).map((phase) => (
                                                    <div key={phase.id}>
                                                        <div className={`text-lg font-bold ${
                                                            phase.color.includes('pink') ? 'text-pink-600' :
                                                            phase.color.includes('blue') ? 'text-blue-600' :
                                                            phase.color.includes('orange') ? 'text-orange-600' :
                                                            phase.color.includes('purple') ? 'text-purple-600' :
                                                            phase.color.includes('indigo') ? 'text-indigo-600' :
                                                            phase.color.includes('green') ? 'text-green-600' :
                                                            phase.color.includes('emerald') ? 'text-emerald-600' :
                                                            phase.color.includes('red') ? 'text-red-600' :
                                                            phase.color.includes('yellow') ? 'text-yellow-600' :
                                                            phase.color.includes('cyan') ? 'text-cyan-600' :
                                                            phase.color.includes('gray') ? 'text-gray-600' :
                                                            phase.color.includes('teal') ? 'text-teal-600' :
                                                            'text-gray-600'
                                                        }`}>{phase.count}</div>
                                                        <div className="text-xs text-gray-500 truncate">{phase.name}</div>
                                                    </div>
                                                ))}
                                            </div>
                                            {stats.phaseStats.length > 5 && (
                                                <div className="grid grid-cols-5 gap-2 text-center">
                                                    {stats.phaseStats.slice(5, 10).map((phase) => (
                                                        <div key={phase.id}>
                                                            <div className={`text-lg font-bold ${
                                                                phase.color.includes('pink') ? 'text-pink-600' :
                                                                phase.color.includes('blue') ? 'text-blue-600' :
                                                                phase.color.includes('orange') ? 'text-orange-600' :
                                                                phase.color.includes('purple') ? 'text-purple-600' :
                                                                phase.color.includes('indigo') ? 'text-indigo-600' :
                                                                phase.color.includes('green') ? 'text-green-600' :
                                                                phase.color.includes('emerald') ? 'text-emerald-600' :
                                                                phase.color.includes('red') ? 'text-red-600' :
                                                                phase.color.includes('yellow') ? 'text-yellow-600' :
                                                                phase.color.includes('cyan') ? 'text-cyan-600' :
                                                                phase.color.includes('gray') ? 'text-gray-600' :
                                                                phase.color.includes('teal') ? 'text-teal-600' :
                                                                'text-gray-600'
                                                            }`}>{phase.count}</div>
                                                            <div className="text-xs text-gray-500 truncate">{phase.name}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>

                    <AddPositionModal
                        isOpen={showAddPosition}
                        newPosition={newPosition}
                        onPositionChange={setNewPosition}
                        onAdd={addPosition}
                        onCancel={() => setShowAddPosition(false)}
                    />

                    <CandidateFilterModal
                        isOpen={showFilterModal}
                        positions={positions}
                        onClose={() => setShowFilterModal(false)}
                        onNavigateToCandidate={handleNavigateToCandidate}
                    />
                </div>
            );
        };

        // メインアプリ
        const App = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(() => {
                try {
                    return localStorage.getItem('authenticated') === 'true';
                } catch {
                    return false;
                }
            });

            const handleLogin = () => {
                setIsAuthenticated(true);
                try {
                    localStorage.setItem('authenticated', 'true');
                } catch (error) {
                    console.error('Failed to save authentication state:', error);
                }
            };

            const handleLogout = () => {
                setIsAuthenticated(false);
                try {
                    localStorage.removeItem('authenticated');
                } catch (error) {
                    console.error('Failed to remove authentication state:', error);
                }
            };

            if (!isAuthenticated) {
                return <LoginComponent onLogin={handleLogin} />;
            }

            return (
                <div className="relative">
                    <div className="fixed top-4 right-4 z-30">
                        <button 
                            onClick={handleLogout}
                            className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm shadow-lg flex items-center space-x-2"
                        >
                            <LogOut />
                            <span>ログアウト</span>
                        </button>
                    </div>
                    <RecruitmentSystem />
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
