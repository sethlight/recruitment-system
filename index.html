<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>採用管理システム（社内共有版）</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .lucide { width: 1em; height: 1em; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;}
    .draggable { cursor: grab; }
    .dragging { opacity: 0.5; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // -------- アイコン略（割愛、前回のままでOK） --------

    // 定数・データはそのまま

    // -- 各種定数 ここは元のままでOK -- 

    // ユーティリティ
    function uuid() { return '_' + Math.random().toString(36).substr(2, 9); }

    // --- 候補者追加・編集モーダル ---
    function CandidateModal({ open, onClose, onSave, candidate, customFields }) {
      const [values, setValues] = useState(() => candidate || {
        id: uuid(),
        name: '',
        ...Object.fromEntries(customFields.map(f=>[f.id, ''])),
        createdAt: new Date().toISOString(),
        history: [],
      });

      useEffect(() => {
        if (candidate) setValues(candidate);
      }, [candidate]);

      if (!open) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded shadow max-w-sm w-full">
            <h2 className="font-bold mb-2">{candidate ? "候補者編集" : "新規候補者追加"}</h2>
            <div className="mb-2">
              <label className="block text-xs mb-1">氏名*</label>
              <input className="border px-2 py-1 rounded w-full"
                value={values.name}
                onChange={e=>setValues(v=>({...v, name: e.target.value}))}
              />
            </div>
            {customFields.map(f=>(
              <div className="mb-2" key={f.id}>
                <label className="block text-xs mb-1">{f.name}{f.required && '*'}</label>
                <input
                  className="border px-2 py-1 rounded w-full"
                  type={f.type==='number'?'number':'text'}
                  value={values[f.id]||''}
                  onChange={e=>setValues(v=>({...v, [f.id]:e.target.value}))}
                />
              </div>
            ))}
            <div className="flex space-x-2 justify-end mt-4">
              <button className="bg-gray-200 rounded px-3 py-1" onClick={onClose}>キャンセル</button>
              <button className="bg-blue-600 text-white rounded px-3 py-1"
                onClick={()=>{onSave(values);onClose();}}>保存</button>
            </div>
          </div>
        </div>
      );
    }

    // --- フェーズ編集モーダル ---
    function PhaseEditModal({ open, onClose, phases, onSave }) {
      const [localPhases, setLocalPhases] = useState(phases);
      useEffect(()=>{ setLocalPhases(phases.map(p=>({...p})) ); }, [phases]);
      if(!open) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded shadow w-full max-w-md">
            <h2 className="font-bold mb-3">フェーズ編集</h2>
            <div className="space-y-2">
              {localPhases.map((phase,i)=>(
                <div key={phase.id} className="flex space-x-2 items-center">
                  <input className="border rounded px-2 py-1 w-28"
                    value={phase.name}
                    onChange={e=>{
                      const arr=[...localPhases]; arr[i].name = e.target.value; setLocalPhases(arr);
                    }}
                  />
                  <select value={phase.color} onChange={e=>{
                    const arr=[...localPhases]; arr[i].color=e.target.value; setLocalPhases(arr);
                  }}>
                    <option value="">色</option>
                    {AVAILABLE_COLORS.map(c=>
                      <option key={c.value} value={c.value}>{c.label}</option>
                    )}
                  </select>
                  <button className="text-red-500" onClick={()=>{
                    setLocalPhases(ph=>ph.filter((_,j)=>j!==i));
                  }}>削除</button>
                </div>
              ))}
              <button className="bg-blue-100 rounded px-3 py-1 mt-2" onClick={()=>
                setLocalPhases([...localPhases, {id: uuid(), name:'新規フェーズ', color:'bg-gray-500', candidates:[]}])
              }>＋追加</button>
            </div>
            <div className="flex space-x-2 justify-end mt-4">
              <button className="bg-gray-200 rounded px-3 py-1" onClick={onClose}>閉じる</button>
              <button className="bg-blue-600 text-white rounded px-3 py-1"
                onClick={()=>{onSave(localPhases);onClose();}}>保存</button>
            </div>
          </div>
        </div>
      );
    }

    // --- カスタムフィールド編集モーダル ---
    function FieldEditModal({ open, onClose, fields, onSave }) {
      const [localFields, setLocalFields] = useState(fields);
      useEffect(()=>{ setLocalFields(fields.map(f=>({...f}))); }, [fields]);
      if(!open) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded shadow w-full max-w-md">
            <h2 className="font-bold mb-3">カスタムフィールド編集</h2>
            <div className="space-y-2">
              {localFields.map((f,i)=>(
                <div key={f.id} className="flex space-x-2 items-center">
                  <input className="border px-2 py-1 rounded w-28"
                    value={f.name} onChange={e=>{
                      const arr=[...localFields]; arr[i].name=e.target.value; setLocalFields(arr);
                    }}/>
                  <select value={f.type} onChange={e=>{
                    const arr=[...localFields]; arr[i].type=e.target.value; setLocalFields(arr);
                  }}>
                    {FIELD_TYPES.map(ft=>
                      <option key={ft.value} value={ft.value}>{ft.label}</option>
                    )}
                  </select>
                  <label>
                    <input type="checkbox" checked={f.required} onChange={e=>{
                      const arr=[...localFields]; arr[i].required=e.target.checked; setLocalFields(arr);
                    }}/>必須
                  </label>
                  <button className="text-red-500" onClick={()=>setLocalFields(localFields.filter((_,j)=>j!==i))}>削除</button>
                </div>
              ))}
              <button className="bg-blue-100 rounded px-3 py-1 mt-2" onClick={()=>
                setLocalFields([...localFields, {id:uuid(), name:'新フィールド', type:'text', required:false}])
              }>＋追加</button>
            </div>
            <div className="flex space-x-2 justify-end mt-4">
              <button className="bg-gray-200 rounded px-3 py-1" onClick={onClose}>閉じる</button>
              <button className="bg-blue-600 text-white rounded px-3 py-1"
                onClick={()=>{onSave(localFields);onClose();}}>保存</button>
            </div>
          </div>
        </div>
      );
    }

    // --- データ管理（エクスポート/インポート/クリア） ---
    function DataManageModal({ open, onClose, positions, setPositions }) {
      if (!open) return null;
      return (
        <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
          <div className="bg-white p-6 rounded shadow w-full max-w-md">
            <h2 className="font-bold mb-3">データ管理</h2>
            <div className="space-y-2">
              <button className="bg-blue-100 px-3 py-1 rounded w-full" onClick={()=>{
                navigator.clipboard.writeText(JSON.stringify(positions));
                alert("データをコピーしました（メモ帳等に貼付可）");
              }}>エクスポート</button>
              <input type="file" className="w-full" accept=".json" onChange={e=>{
                const file = e.target.files[0];
                if (file) {
                  const reader = new FileReader();
                  reader.onload = ev => {
                    try {
                      setPositions(JSON.parse(ev.target.result));
                      alert('データ読込完了');
                      onClose();
                    } catch { alert('読み込みエラー'); }
                  };
                  reader.readAsText(file);
                }
              }}/>
              <button className="bg-red-100 px-3 py-1 rounded w-full" onClick={()=>{
                if (window.confirm('全データを初期化します。よろしいですか？')) setPositions([]);
              }}>全データクリア</button>
            </div>
            <button className="mt-4 px-4 py-1 rounded bg-gray-200" onClick={onClose}>閉じる</button>
          </div>
        </div>
      );
    }

    // --- 候補者カードコンポーネント（ドラッグ対応） ---
    function CandidateCard({ candidate, onEdit, onDelete, onDragStart, onDragEnd, draggable }) {
      return (
        <div
          draggable={draggable}
          onDragStart={onDragStart}
          onDragEnd={onDragEnd}
          className="bg-white p-3 rounded border draggable mb-1"
        >
          <div className="font-medium text-sm flex items-center justify-between">
            {candidate.name}
            <span>
              <button className="text-xs text-blue-600" onClick={onEdit}>編集</button>
              <button className="text-xs text-red-600 ml-2" onClick={onDelete}>削除</button>
            </span>
          </div>
          <div className="text-xs text-gray-500 mt-1">{new Date(candidate.createdAt).toLocaleDateString()}</div>
        </div>
      );
    }

    // --- カンバン（ドラッグ＆ドロップ含む） ---
    function KanbanBoard({ position, onUpdate }) {
      // 編集モーダル
      const [modal, setModal] = useState({ open: false, candidate: null, phaseId: null });

      // ドラッグ用
      const [dragged, setDragged] = useState(null);

      // 候補者追加/編集
      const handleSave = (candidate, phaseId) => {
        onUpdate(draft => {
          const pos = draft.find(p=>p.id===position.id);
          pos.phases.forEach(phase=>{
            phase.candidates = phase.candidates.filter(c=>c.id!==candidate.id);
          });
          const phase = pos.phases.find(p=>p.id===phaseId);
          if(candidate.history==null) candidate.history=[];
          if(!candidate.history.length || candidate.history[candidate.history.length-1]?.phase!==phase.name)
            candidate.history.push({ phase: phase.name, at: new Date().toISOString() });
          phase.candidates.push(candidate);
        });
      };

      // 候補者削除
      const handleDelete = (cid) => {
        onUpdate(draft=>{
          const pos = draft.find(p=>p.id===position.id);
          pos.phases.forEach(phase=>phase.candidates=phase.candidates.filter(c=>c.id!==cid));
        });
      };

      // ドラッグ開始
      const handleDragStart = (phaseId, cid) => {
        setDragged({phaseId, cid});
      };

      // ドロップ
      const handleDrop = (phaseId) => {
        if (!dragged) return;
        const candidate = position.phases.find(p=>p.id===dragged.phaseId).candidates.find(c=>c.id===dragged.cid);
        handleSave(candidate, phaseId);
        setDragged(null);
      };

      // フェーズ編集・カスタムフィールド編集モーダル
      const [phaseEdit, setPhaseEdit] = useState(false);
      const [fieldEdit, setFieldEdit] = useState(false);
      const [showHistory, setShowHistory] = useState(null);

      return (
        <div>
          <div className="flex mb-2 justify-between">
            <span className="font-bold">{position.name} - カンバン</span>
            <div className="flex space-x-2">
              <button className="bg-blue-100 rounded px-2 py-1 text-xs" onClick={()=>setPhaseEdit(true)}>フェーズ編集</button>
              <button className="bg-green-100 rounded px-2 py-1 text-xs" onClick={()=>setFieldEdit(true)}>カスタムフィールド</button>
            </div>
          </div>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
            {position.phases.map(phase => (
              <div key={phase.id} className="bg-gray-50 rounded p-2 min-h-[150px]"
                onDragOver={e=>{e.preventDefault();}}
                onDrop={e=>{e.preventDefault();handleDrop(phase.id);}}
              >
                <div className="flex items-center space-x-2 mb-2">
                  <div className={`w-3 h-3 rounded-full ${phase.color}`}></div>
                  <span className="font-semibold">{phase.name}</span>
                  <span className="text-xs text-gray-400">({phase.candidates.length})</span>
                </div>
                <div>
                  {phase.candidates.map(candidate=>(
                    <CandidateCard key={candidate.id}
                      candidate={candidate}
                      onEdit={()=>setModal({open:true,candidate,phaseId:phase.id})}
                      onDelete={()=>handleDelete(candidate.id)}
                      draggable={true}
                      onDragStart={e=>handleDragStart(phase.id, candidate.id)}
                      onDragEnd={()=>setDragged(null)}
                    />
                  ))}
                  {phase.candidates.length===0 && <div className="text-xs text-gray-400 py-3 text-center">候補者なし</div>}
                </div>
                <button className="mt-1 bg-blue-100 px-2 py-1 text-xs rounded w-full"
                  onClick={()=>setModal({open:true, candidate:null, phaseId:phase.id})}
                >＋追加</button>
              </div>
            ))}
          </div>
          <div className="mt-4">
            <span className="font-bold">履歴確認：</span>
            {position.phases.map(phase=>phase.candidates).flat().map(candidate=>(
              <button key={candidate.id} className="text-xs underline mr-2"
                onClick={()=>setShowHistory(candidate)}>{candidate.name}</button>
            ))}
          </div>
          {/* 履歴モーダル */}
          {showHistory && (
            <div className="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
              <div className="bg-white p-6 rounded shadow w-full max-w-xs">
                <h3 className="font-bold mb-2">{showHistory.name}さんの移動履歴</h3>
                <ul className="text-xs">
                  {showHistory.history?.map((h,i)=>(
                    <li key={i}>{h.phase} ({new Date(h.at).toLocaleString()})</li>
                  ))}
                </ul>
                <button className="mt-4 px-4 py-1 rounded bg-gray-200" onClick={()=>setShowHistory(null)}>閉じる</button>
              </div>
            </div>
          )}
          <CandidateModal
            open={modal.open}
            onClose={()=>setModal({open:false,candidate:null,phaseId:null})}
            onSave={cand=>handleSave(cand, modal.phaseId)}
            candidate={modal.candidate}
            customFields={position.customFields}
          />
          <PhaseEditModal
            open={phaseEdit}
            onClose={()=>setPhaseEdit(false)}
            phases={position.phases}
            onSave={newPhases=>{
              onUpdate(draft=>{
                const pos = draft.find(p=>p.id===position.id);
                // 既存フェーズ名が変更or削除or追加されている場合、候補者を残すロジック（新規は空配列）
                let old = Object.fromEntries(pos.phases.map(p=>[p.id,p.candidates]));
                pos.phases = newPhases.map(p=>({...p, candidates:old[p.id]||[]}));
              });
            }}
          />
          <FieldEditModal
            open={fieldEdit}
            onClose={()=>setFieldEdit(false)}
            fields={position.customFields}
            onSave={fields=>{
              onUpdate(draft=>{
                const pos = draft.find(p=>p.id===position.id);
                pos.customFields = fields;
              });
            }}
          />
        </div>
      );
    }

    // --- メインシステム ---
    function RecruitmentSystem() {
      // 全体データ
      const [positions, setPositions] = useState([]);
      const [selected, setSelected] = useState(null);

      // データ永続化
      useEffect(() => {
        try {
          const saved = localStorage.getItem('salowin_recruitment_data');
          if(saved) setPositions(JSON.parse(saved));
          else loadDefault();
        } catch { loadDefault(); }
      }, []);
      useEffect(() => {
        localStorage.setItem('salowin_recruitment_data', JSON.stringify(positions));
      }, [positions]);
      const loadDefault = () => {
        setPositions([
          {id:1, name:'ネイル本部人員', department:'リテール事業部', hiringManager:'田中', hiringAttribute:'experienced',
            phases: DEFAULT_RECRUITMENT_PHASES.map(ph=>({...ph, candidates:[]})),
            customFields: [
              {id:'contact', name:'連絡先', type:'email', required:true},
              {id:'experience', name:'経験年数', type:'number', required:false}
            ]
          }
        ]);
      };

      // データ更新（イミュータブルだがdraftで直感的に書ける形）
      const updatePositions = fn => setPositions(prev=>{
        const draft = JSON.parse(JSON.stringify(prev));
        fn(draft);
        return draft;
      });

      // ポジション追加・削除
      const addPosition = () => {
        setPositions(prev=>[...prev,{
          id:uuid(),
          name:'新ポジション',
          department:'',
          hiringManager:'',
          hiringAttribute:'none',
          phases: DEFAULT_RECRUITMENT_PHASES.map(ph=>({...ph,candidates:[]})),
          customFields: []
        }]);
      };
      const deletePosition = id => {
        if(window.confirm('このポジションを削除しますか？'))
          setPositions(prev=>prev.filter(p=>p.id!==id));
      };

      // データ管理
      const [dataModal, setDataModal] = useState(false);

      return (
        <div className="p-6 bg-gray-100 min-h-screen">
          <div className="flex items-center justify-between mb-6">
            <h1 className="text-2xl font-bold">採用ポジション管理</h1>
            <div>
              <button className="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg mr-2" onClick={addPosition}>＋新規ポジション</button>
              <button className="bg-gray-400 text-white px-3 py-2 rounded" onClick={()=>setDataModal(true)}>データ管理</button>
            </div>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {positions.map(pos=>(
              <div key={pos.id} className="bg-white rounded-lg shadow-sm border p-6 hover:shadow-md relative">
                <div onClick={()=>setSelected(pos)} className="cursor-pointer">
                  <h3 className="font-semibold text-lg mb-1">{pos.name}</h3>
                  <div className="text-sm text-gray-500 mb-1">{pos.department}</div>
                  <div className="text-xs text-gray-400 mb-1">責任者: {pos.hiringManager||'未設定'}</div>
                  <div className="text-xs text-gray-400 mb-1">属性: {HIRING_ATTRIBUTES.find(a=>a.value===pos.hiringAttribute)?.label||''}</div>
                </div>
                <button className="text-xs text-red-600 absolute top-2 right-2" onClick={()=>deletePosition(pos.id)}>削除</button>
              </div>
            ))}
          </div>
          {selected && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
              <div className="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-xl font-bold">{selected.name} カンバン</h2>
                  <button className="text-gray-500 hover:text-gray-700" onClick={()=>setSelected(null)}>✕</button>
                </div>
                <KanbanBoard position={selected} onUpdate={updatePositions}/>
              </div>
            </div>
          )}
          <DataManageModal open={dataModal} onClose={()=>setDataModal(false)} positions={positions} setPositions={setPositions}/>
        </div>
      );
    }

    // --- 認証などは現状通り ---
    const App = () => {
      const [isAuthenticated, setIsAuthenticated] = useState(()=>{
        try { return localStorage.getItem('salowin_auth_status')==='true'; }
        catch { return false; }
      });
      const handleLogin = () => {
        setIsAuthenticated(true);
        try { localStorage.setItem('salowin_auth_status','true'); }
        catch {}
      };
      const handleLogout = () => {
        setIsAuthenticated(false);
        try { localStorage.removeItem('salowin_auth_status'); }
        catch {}
      };
      if (!isAuthenticated) {
        return <LoginComponent onLogin={handleLogin}/>;
      }
      return (
        <div>
          <div className="absolute top-4 right-4 z-50 flex items-center space-x-2">
            <div className="bg-green-100 text-green-800 px-3 py-1 rounded text-xs">💾 データ自動保存中</div>
            <button onClick={handleLogout} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded text-sm">ログアウト</button>
          </div>
          <RecruitmentSystem />
        </div>
      );
    };

    ReactDOM.render(<App/>, document.getElementById('root'));
  </script>
</body>
</html>
